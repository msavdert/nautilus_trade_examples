# ğŸŒŠ Nautilus Trader - Complete Sandbox Trading System
# ====================================================
# 
# Bu docker-compose dosyasÄ±, tam bir sandbox trading sistemini tek seferde baÅŸlatÄ±r:
# - PostgreSQL: Historical data, orders, trades, positions storage
# - Redis: Real-time market data caching, order book, recent trades
# - Nautilus Trader: Professional trading bot with EMA Cross strategy
#
# ğŸš€ KULLANIM:
#   docker-compose up -d       # TÃ¼m servisleri arka planda baÅŸlat
#   docker-compose logs -f     # LoglarÄ± izle
#   docker-compose stop        # Servisleri durdur
#   docker-compose down        # Servisleri kaldÄ±r (data korunur)
#
# âš ï¸ TESTNET MODU: GerÃ§ek para kullanÄ±lmaz, tamamen gÃ¼venli!

services:
  # ğŸ¤– Nautilus Trader Sandbox Bot
  # Ana trading engine - EMA Cross stratejisi ile otomatik trading
  nautilus-sandbox-trader:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nautilus-sandbox-trader
    env_file:
      - .env
    volumes:
      - .:/app                           # Kaynak kod (sandbox/ iÃ§eriÄŸi)
      - ./logs:/app/logs                 # Log dosyalarÄ±
      - ./data:/app/data                 # Data dosyalarÄ±
    networks:
      - nautilus-network
    depends_on:
      nautilus-postgres:
        condition: service_healthy        # PostgreSQL hazÄ±r olana kadar bekle
      nautilus-redis:
        condition: service_healthy        # Redis hazÄ±r olana kadar bekle
    restart: unless-stopped
    # TÃ¼m environment deÄŸiÅŸkenleri .env dosyasÄ±ndan alÄ±nÄ±r
    command: python sandbox_trader.py     # Ana script Ã§alÄ±ÅŸtÄ±r

  # ğŸ—„ï¸ PostgreSQL Database
  # Historical data, orders, trades, positions storage
  # Trading geÃ§miÅŸi ve kalÄ±cÄ± veriler burada saklanÄ±r
  nautilus-postgres:
    image: postgres:15-alpine             # PostgreSQL 15, Alpine Linux (kÃ¼Ã§Ã¼k)
    container_name: nautilus-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE}               # .env'den database adÄ± (Nautilus standard)
      POSTGRES_USER: ${POSTGRES_USERNAME}             # .env'den kullanÄ±cÄ± adÄ± (Nautilus standard)
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}         # .env'den ÅŸifre (Nautilus standard)
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data        # KalÄ±cÄ± data storage
      - ./data/postgres_init:/docker-entrypoint-initdb.d  # Init scripts
    ports:
      - "${POSTGRES_EXPOSED_PORT}:5432"                       # .env'den PostgreSQL portunu host'a aÃ§
    networks:
      - nautilus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USERNAME}"]  # .env'den kullanÄ±cÄ± adÄ± (Nautilus standard)
      interval: 30s                       # 30 saniyede bir kontrol
      timeout: 10s                        # 10 saniye timeout
      retries: 3                          # 3 kez dene
    # Production optimizations (opsiyonel)
    command: >
      postgres
        -c shared_preload_libraries=pg_stat_statements
        -c max_connections=200
        -c shared_buffers=256MB
        -c effective_cache_size=1GB
        -c maintenance_work_mem=64MB
        -c checkpoint_completion_target=0.9
        -c wal_buffers=16MB
        -c default_statistics_target=100

  # ğŸš€ Redis Cache
  # Real-time market data, order book, recent trades caching
  # HÄ±zlÄ± eriÅŸim gereken veriler burada tutulur
  nautilus-redis:
    image: redis:7-alpine                 # Redis 7, Alpine Linux (kÃ¼Ã§Ã¼k)
    container_name: nautilus-redis
    sysctls:
      - net.core.somaxconn=1024           # Connection queue size
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - redis_data:/data                  # KalÄ±cÄ± Redis data
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro  # Redis config dosyasÄ±
    ports:
      - "${REDIS_EXPOSED_PORT}:6379"                       # .env'den Redis portunu host'a aÃ§
    networks:
      - nautilus-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]  # Redis saÄŸlÄ±k kontrolÃ¼
      interval: 30s                       # 30 saniyede bir kontrol
      timeout: 10s                        # 10 saniye timeout
      retries: 3                          # 3 kez dene

# ğŸ’¾ KalÄ±cÄ± Data Volume'larÄ±
# Bu volume'lar, container'lar silinse bile verilerinizi korur
volumes:
  postgres_data:
    driver: local                         # Yerel disk'te sakla
    # Production'da external volume kullanabilirsiniz:
    # external: true
    # name: nautilus_postgres_data
    
  redis_data:
    driver: local                         # Yerel disk'te sakla
    # Production'da external volume kullanabilirsiniz:
    # external: true  
    # name: nautilus_redis_data

# ğŸŒ Network Configuration
# TÃ¼m servisler aynÄ± network'te, birbirleriyle konuÅŸabilir
networks:
  nautilus-network:
    driver: bridge                        # Bridge network driver
    # Production'da custom network ayarlarÄ±:
    # ipam:
    #   config:
    #     - subnet: 172.20.0.0/16
